#!/usr/bin/env bash

################################################################################
# AUTOR: Victor Dias Marques                                                   #
# CONTATO: victordmarx@pm.me                                                   #
# DATA: 17/02/2026                                                             #
# DESCRIÇÃO: Gera backups de arquivos pessoais                                 #
# VERSÃO: 2.0.0                                                                #
################################################################################

data=$(date "+%Y-%m-%d")
array_dirs=()
last_bkp='/var/home/victor/Seagate/Pessoal/programacao/bash/backups/last_bkp.txt'

function comp_cript(){
    local dir_ori="$1"
    local nom_arq="$2"
    local destino="/var/home/victor/Seagate/Backups/$nom_arq.gpg"

    if gum spin --spinner points --title "Compactando e criptografando $nom_arq" -- tar -cz -C "$dir_ori" . | gpg -o "$destino" -e -r "Backup pessoal" ; then
	gum style \
            --foreground 2 \
            --border-foreground 2 \
            --border double \
            --align center \
            --width 50 \
            --margin "1 2" \
            --padding "1" \
            "✅ Backup concluído!" "Arquivo: $nom_arq.gpg"
	return 0

    else
	gum style \
            --foreground 1 \
            --border-foreground 1 \
            --border double \
            --align center \
            --width 50 \
            "❌ ERRO CRÍTICO" "Falha ao processar $dir_ori"
        return 1
    fi    
}

function checa_data_bkp(){
    while IFS="|" read -r pasta data_bkp; do
	local ult_mod=$(stat $pasta | grep Modify | awk {'print $2'})

	if [[ "$1" -eq 1 ]]; then
	    if [[ $data_bkp < $ult_mod ]]; then
		array_dirs+=("$pasta")
	    fi
	else
	    array_dirs+=("$pasta")
	fi
	
    done < "$last_bkp"
}

function atualiza_data_bkp(){
    local pasta_alvo="$1"

    sed "s#^${pasta_alvo}|.*#${pasta_alvo}|${data}#" "$last_bkp" > "${last_bkp}.tmp" && mv "${last_bkp}.tmp" "$last_bkp"
	
}

function backup_total(){
    nom_arq="backup_total_$data"
    comp_cript '/var/home/victor/Seagate/Pessoal' $nom_arq

    transfere=$(gum choose --header 'Deseja transferir o backup total?' 'Sim' 'Não')

    case "$transfere" in
	Sim) ./transfere_bkp "$nom_arq.gpg" ;;
	Não) exit 0 ;;
    esac
}

function backup_total_separado(){
    checa_data_bkp 1
    for i in ${array_dirs[@]} ; do
	base_dir=$(basename $i)
	comp_cript $i "${base_dir}_${data}"

	if [[ $? == 0 ]] ; then
	    atualiza_data_bkp $i
	else
	    continue
	fi
	
    done
}

function backup_parcial(){
    checa_data_bkp 0
    #echo ${array_dirs[@]}
    local selecionadas=$(gum choose --no-limit --header 'Selecione os diretórios para backup' ${array_dirs[@]})

    while IFS= read -r pasta; do
	base_dir=$(basename $pasta)
	comp_cript $pasta "${base_dir}_${data}"

	if [[ $? == 0 ]] ; then
	    atualiza_data_bkp $pasta
	else
	    continue
	fi
    done <<< $selecionadas
}


if (( $# != 1 )); then # valida se a quantidade de parâmetros informados ($#) não é igual a 1.
    option=$(gum choose 'Backup total' 'Backup total separado' 'Backup parcial' 'Backup de domingo' 'Sair' | tr -d ' ')

    case "$option" in
	Backuptotal) backup_total ;;
	Backuptotalseparado) backup_total_separado ;;
	Backupparcial) backup_parcial ;;
	Backupdedomingo) rm -f /var/home/victor/Seagate/Backups/* ; backup_total_separado ; backup_total ;;
	Sair) exit 0 ;;
    esac

else
    case "$1" in
	-t) backup_total ;;
	-ts) backup_total_separado ;;
	-p) backup_parcial ;;
	-d) rm -f /var/home/victor/Seagate/Backups/* ; backup_total_separado ; backup_total ;;
	*) echo 'inválido' ; exit 1 ;;
    esac
fi
